<% content_for :page_title, "ì˜¤ë‹µë…¸íŠ¸" %>

<!-- Header Section -->
<div class="dashboard-header text-center">
  <h1 class="dashboard-title">ğŸ“ ì˜¤ë‹µë…¸íŠ¸</h1>
  <p class="dashboard-subtitle">í‹€ë¦° ë¬¸ì œë“¤ì„ ë³µìŠµí•˜ì—¬<br>ì‹¤ë ¥ì„ í–¥ìƒì‹œì¼œë³´ì„¸ìš”</p>
</div>

<!-- Summary Stats -->
<div class="dashboard-stats">
  <div class="dashboard-stat-card">
    <div class="dashboard-stat-header">
      <span class="dashboard-stat-title">ì´ ì˜¤ë‹µ</span>
      <span class="dashboard-stat-icon">âŒ</span>
    </div>
    <div class="dashboard-stat-value"><%= @wrong_answers_stats[:total_count] || 15 %>ê°œ</div>
    <div class="dashboard-stat-change dashboard-stat-change--neutral">
      <span>ìµœê·¼ ì¶”ê°€ 3ê°œ</span>
    </div>
  </div>
  
  <div class="dashboard-stat-card">
    <div class="dashboard-stat-header">
      <span class="dashboard-stat-title">ë³µìŠµì™„ë£Œ</span>
      <span class="dashboard-stat-icon">âœ…</span>
    </div>
    <div class="dashboard-stat-value"><%= @wrong_answers_stats[:reviewed_count] || 8 %>ê°œ</div>
    <div class="dashboard-stat-change dashboard-stat-change--positive">
      <span>53% ì™„ë£Œ</span>
    </div>
  </div>
  
  <div class="dashboard-stat-card">
    <div class="dashboard-stat-header">
      <span class="dashboard-stat-title">í‰ê· ì ìˆ˜</span>
      <span class="dashboard-stat-icon">ğŸ“Š</span>
    </div>
    <div class="dashboard-stat-value"><%= @wrong_answers_stats[:avg_retry_score] || 72 %>ì </div>
    <div class="dashboard-stat-change dashboard-stat-change--positive">
      <span>â†—ï¸ +8ì  í–¥ìƒ</span>
    </div>
  </div>
</div>

<!-- Filter and Search -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">ğŸ” í•„í„° ë° ê²€ìƒ‰</h3>
  </div>
  <div class="card-content">
    <div class="form-group">
      <div class="search-form">
        <input type="text" class="search-form-input" placeholder="ë¬¸ì œ ë‚´ìš© ê²€ìƒ‰..." id="wrong-answer-search">
        <button class="search-form-button" type="button">
          <span class="search-form-icon">ğŸ”</span>
        </button>
      </div>
    </div>
    
    <div class="button-group button-group--quiz-filters" style="margin-top: var(--space-4);">
      <button class="button button--outline button--sm filter-btn active" data-filter="all">ì „ì²´</button>
      <button class="button button--outline button--sm filter-btn" data-filter="subject-1">ìê¸ˆì„¸íƒë°©ì§€ë²•</button>
      <button class="button button--outline button--sm filter-btn" data-filter="subject-2">ê³ ê°í™•ì¸ì œë„</button>
      <button class="button button--outline button--sm filter-btn" data-filter="subject-3">ì˜ì‹¬ê±°ë˜ì‹ ê³ </button>
    </div>
    
    <div class="button-group" style="margin-top: var(--space-3);">
      <button class="button button--outline button--sm filter-btn" data-filter="not-reviewed">ë¯¸ë³µìŠµ</button>
      <button class="button button--outline button--sm filter-btn" data-filter="reviewed">ë³µìŠµì™„ë£Œ</button>
      <button class="button button--outline button--sm filter-btn" data-filter="bookmarked">ë¶ë§ˆí¬</button>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="button-group" style="margin-bottom: var(--space-6);">
  <%= link_to new_wrong_answer_quiz_path, class: "button button--primary" do %>
    ğŸ¯ ì˜¤ë‹µ í€´ì¦ˆ ì‹œì‘
  <% end %>
  
  <button class="button button--outline" onclick="reviewAllWrongAnswers()">
    ğŸ“š ì „ì²´ ë³µìŠµ
  </button>
</div>

<!-- Wrong Answers List -->
<div class="wrong-answers-list">
  
  <!-- Wrong Answer Item 1 -->
  <div class="wrong-answer-item" data-subject="subject-1" data-status="not-reviewed">
    <div class="wrong-answer-header">
      <div class="wrong-answer-subject">
        <span class="subject-badge subject-badge--subject-1">ìê¸ˆì„¸íƒë°©ì§€ë²•</span>
        <span class="wrong-answer-date">2ì¼ ì „</span>
      </div>
      <div class="wrong-answer-actions">
        <button class="wrong-answer-action wrong-answer-bookmark active" onclick="toggleBookmark(this)">
          <span>ğŸ”–</span>
        </button>
        <span class="wrong-answer-status wrong-answer-status--not-reviewed">ë¯¸ë³µìŠµ</span>
      </div>
    </div>
    
    <div class="wrong-answer-content">
      <div class="wrong-answer-question">
        <h4 class="wrong-answer-question-title">Q. ìê¸ˆì„¸íƒë°©ì§€ë²•ìƒ ê³ ê°í™•ì¸ ì˜ë¬´ë¥¼ ì´í–‰í•´ì•¼ í•˜ëŠ” ê±°ë˜ ê¸°ì¤€ ê¸ˆì•¡ì€?</h4>
      </div>
      
      <div class="wrong-answer-details">
        <div class="dashboard-stats" style="margin: var(--space-3) 0;">
          <div class="dashboard-stat-card dashboard-stat-card--compact">
            <div class="dashboard-stat-title">ì •ë‹µ</div>
            <div class="dashboard-stat-value" style="color: var(--success-600); font-size: var(--text-sm);">C. 1000ë§Œì› ì´ìƒ</div>
          </div>
          <div class="dashboard-stat-card dashboard-stat-card--compact">
            <div class="dashboard-stat-title">ë‚´ ë‹µì•ˆ</div>
            <div class="dashboard-stat-value" style="color: var(--error-600); font-size: var(--text-sm);">B. 500ë§Œì› ì´ìƒ</div>
          </div>
        </div>
      </div>
      
      <div class="collapsible">
        <div class="collapsible-trigger">
          <span class="collapsible-title">ğŸ’¡ í•´ì„¤ ë³´ê¸°</span>
          <span class="collapsible-icon">â–¼</span>
        </div>
        <div class="collapsible-content">
          <div class="collapsible-content-inner">
            <p class="quiz-explanation">
              ìê¸ˆì„¸íƒë°©ì§€ë²• ì œ4ì¡°ì— ë”°ë¼ 1000ë§Œì› ì´ìƒì˜ ê±°ë˜ ì‹œ ê³ ê°í™•ì¸ì˜ë¬´ê°€ ë°œìƒí•©ë‹ˆë‹¤. ì´ëŠ” ê¸ˆìœµê¸°ê´€ì˜ í•µì‹¬ ì˜ë¬´ì‚¬í•­ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.
            </p>
            <div style="margin-top: var(--space-3);">
              <h5 class="card-title">ğŸ“š ê´€ë ¨ ë²•ì¡°ë¬¸</h5>
              <ul style="margin: var(--space-2) 0; padding-left: var(--space-4);">
                <li>â€¢ ìê¸ˆì„¸íƒë°©ì§€ë²• ì œ4ì¡°</li>
                <li>â€¢ ì‹œí–‰ë ¹ ì œ7ì¡°</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div class="button-group button-group--horizontal" style="margin-top: var(--space-4);">
        <%= link_to retry_wrong_answer_path(1), class: "button button--retry-quiz button--sm" do %>
          ë‹¤ì‹œí’€ê¸°
        <% end %>
        <button class="button button--outline button--sm" onclick="markAsReviewed(this)">
          ë³µìŠµì™„ë£Œ
        </button>
        <button class="button button--outline button--sm" onclick="addNote(this)">
          ğŸ“ ë©”ëª¨
        </button>
      </div>
    </div>
  </div>

  <!-- Wrong Answer Item 2 -->
  <div class="wrong-answer-item" data-subject="subject-2" data-status="reviewed">
    <div class="wrong-answer-header">
      <div class="wrong-answer-subject">
        <span class="subject-badge subject-badge--subject-2">ê³ ê°í™•ì¸ì œë„</span>
        <span class="wrong-answer-date">1ì£¼ ì „</span>
      </div>
      <div class="wrong-answer-actions">
        <button class="wrong-answer-action wrong-answer-bookmark" onclick="toggleBookmark(this)">
          <span>ğŸ”–</span>
        </button>
        <span class="wrong-answer-status wrong-answer-status--reviewed">ë³µìŠµì™„ë£Œ âœ“</span>
      </div>
    </div>
    
    <div class="wrong-answer-content">
      <div class="wrong-answer-question">
        <h4 class="wrong-answer-question-title">Q. ê³ ê°í™•ì¸ì œë„ì—ì„œ ìš”êµ¬ë˜ëŠ” ì‹ ë¶„í™•ì¸ ë°©ë²•ìœ¼ë¡œ ì˜¬ë°”ë¥¸ ê²ƒì€?</h4>
      </div>
      
      <div class="wrong-answer-details">
        <div class="dashboard-stats" style="margin: var(--space-3) 0;">
          <div class="dashboard-stat-card dashboard-stat-card--compact">
            <div class="dashboard-stat-title">ì •ë‹µ</div>
            <div class="dashboard-stat-value" style="color: var(--success-600); font-size: var(--text-sm);">A. ì‹ ë¶„ì¦ í™•ì¸</div>
          </div>
          <div class="dashboard-stat-card dashboard-stat-card--compact">
            <div class="dashboard-stat-title">ë‚´ ë‹µì•ˆ</div>
            <div class="dashboard-stat-value" style="color: var(--error-600); font-size: var(--text-sm);">D. ê³„ì¢Œë²ˆí˜¸ë§Œ í™•ì¸</div>
          </div>
        </div>
        
        <div class="wrong-answer-retry-score">
          <span class="badge badge--success">ì¬ì‹œë„: 95ì </span>
        </div>
      </div>
      
      <div class="button-group button-group--horizontal" style="margin-top: var(--space-4);">
        <%= link_to retry_wrong_answer_path(2), class: "button button--outline button--sm" do %>
          ë‹¤ì‹œí’€ê¸°
        <% end %>
        <button class="button button--outline button--sm" onclick="removeFromReviewed(this)">
          ë³µìŠµì·¨ì†Œ
        </button>
      </div>
    </div>
  </div>

  <!-- Wrong Answer Item 3 -->
  <div class="wrong-answer-item" data-subject="subject-3" data-status="not-reviewed" data-bookmarked="true">
    <div class="wrong-answer-header">
      <div class="wrong-answer-subject">
        <span class="subject-badge subject-badge--subject-3">ì˜ì‹¬ê±°ë˜ì‹ ê³ </span>
        <span class="wrong-answer-date">3ì¼ ì „</span>
      </div>
      <div class="wrong-answer-actions">
        <button class="wrong-answer-action wrong-answer-bookmark active" onclick="toggleBookmark(this)">
          <span>ğŸ“‘</span>
        </button>
        <span class="wrong-answer-status wrong-answer-status--not-reviewed">ë¯¸ë³µìŠµ</span>
      </div>
    </div>
    
    <div class="wrong-answer-content">
      <div class="wrong-answer-question">
        <h4 class="wrong-answer-question-title">Q. ì˜ì‹¬ê±°ë˜ ì‹ ê³  ëŒ€ìƒì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê²ƒì€?</h4>
      </div>
      
      <div class="wrong-answer-details">
        <div class="dashboard-stats" style="margin: var(--space-3) 0;">
          <div class="dashboard-stat-card dashboard-stat-card--compact">
            <div class="dashboard-stat-title">ì •ë‹µ</div>
            <div class="dashboard-stat-value" style="color: var(--success-600); font-size: var(--text-sm);">B. ì •ìƒì ì¸ ê¸‰ì—¬ì´ì²´</div>
          </div>
          <div class="dashboard-stat-card dashboard-stat-card--compact">
            <div class="dashboard-stat-title">ë‚´ ë‹µì•ˆ</div>
            <div class="dashboard-stat-value" style="color: var(--error-600); font-size: var(--text-sm);">A. í˜„ê¸ˆ ëŒ€ëŸ‰ê±°ë˜</div>
          </div>
        </div>
      </div>
      
      <div class="button-group button-group--horizontal" style="margin-top: var(--space-4);">
        <%= link_to retry_wrong_answer_path(3), class: "button button--retry-quiz button--sm" do %>
          ë‹¤ì‹œí’€ê¸°
        <% end %>
        <button class="button button--outline button--sm" onclick="markAsReviewed(this)">
          ë³µìŠµì™„ë£Œ
        </button>
        <button class="button button--outline button--sm" onclick="addNote(this)">
          ğŸ“ ë©”ëª¨
        </button>
      </div>
    </div>
  </div>

</div>

<!-- Load More Button -->
<div class="text-center" style="margin-top: var(--space-6);">
  <button class="button button--outline" onclick="loadMoreWrongAnswers()">
    ë” ë§ì€ ì˜¤ë‹µ ë³´ê¸° (12ê°œ ë”)
  </button>
</div>

<!-- Empty State (hidden by default) -->
<div class="empty-state" id="empty-wrong-answers" style="display: none;">
  <div class="empty-state-icon">ğŸ‰</div>
  <h3 class="empty-state-title">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!</h3>
  <p class="empty-state-description">
    ëª¨ë“  ë¬¸ì œë¥¼ ì •ë‹µìœ¼ë¡œ ë§ì·„ê±°ë‚˜<br>
    ì•„ì§ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
  </p>
  <%= link_to quiz_selection_path, class: "button button--primary button--lg" do %>
    í€´ì¦ˆ ì‹œì‘í•˜ê¸°
  <% end %>
</div>

<style>
.wrong-answer-item {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-4);
  padding: var(--space-4);
  transition: all 0.2s ease;
}

.wrong-answer-item:hover {
  border-color: var(--gray-300);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.wrong-answer-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--space-3);
}

.wrong-answer-subject {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.wrong-answer-date {
  font-size: var(--text-sm);
  color: var(--text-secondary);
}

.wrong-answer-actions {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.wrong-answer-action {
  background: none;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-md);
  padding: var(--space-1) var(--space-2);
  cursor: pointer;
  transition: all 0.2s ease;
}

.wrong-answer-action:hover {
  border-color: var(--primary-400);
}

.wrong-answer-action.active {
  background: var(--primary-50);
  border-color: var(--primary-400);
}

.wrong-answer-bookmark span {
  font-size: var(--text-sm);
}

.wrong-answer-status {
  font-size: var(--text-xs);
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-sm);
  font-weight: var(--font-medium);
}

.wrong-answer-status--not-reviewed {
  background: var(--error-50);
  color: var(--error-700);
}

.wrong-answer-status--reviewed {
  background: var(--success-50);
  color: var(--success-700);
}

.wrong-answer-question-title {
  font-size: var(--text-base);
  font-weight: var(--font-medium);
  color: var(--text-primary);
  line-height: var(--leading-relaxed);
  margin: 0;
}

.wrong-answer-details {
  margin: var(--space-3) 0;
}

.wrong-answer-retry-score {
  margin-top: var(--space-2);
}

.dashboard-stat-card--compact {
  padding: var(--space-2);
}

.dashboard-stat-card--compact .dashboard-stat-title {
  font-size: var(--text-xs);
  margin-bottom: var(--space-1);
}

.dashboard-stat-card--compact .dashboard-stat-value {
  font-size: var(--text-sm);
}

.subject-badge {
  font-size: var(--text-xs);
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-sm);
  font-weight: var(--font-medium);
}

.subject-badge--subject-1 {
  background: var(--subject-1-50);
  color: var(--subject-1-700);
}

.subject-badge--subject-2 {
  background: var(--subject-2-50);
  color: var(--subject-2-700);
}

.subject-badge--subject-3 {
  background: var(--subject-3-50);
  color: var(--subject-3-700);
}

.button-group--quiz-filters {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
}

.filter-btn.active {
  background: var(--primary-500);
  color: white;
  border-color: var(--primary-500);
}

.empty-state {
  text-align: center;
  padding: var(--space-8);
  color: var(--text-secondary);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: var(--space-4);
}

.empty-state-title {
  font-size: var(--text-xl);
  font-weight: var(--font-bold);
  margin-bottom: var(--space-2);
  color: var(--text-primary);
}

.empty-state-description {
  font-size: var(--text-base);
  line-height: var(--leading-relaxed);
  margin-bottom: var(--space-6);
}

@media (max-width: 768px) {
  .wrong-answer-header {
    flex-direction: column;
    gap: var(--space-2);
    align-items: flex-start;
  }
  
  .wrong-answer-actions {
    width: 100%;
    justify-content: space-between;
  }
  
  .dashboard-stats {
    grid-template-columns: 1fr;
    gap: var(--space-2);
  }
  
  .button-group--quiz-filters {
    justify-content: center;
  }
}
</style>

<script>
// Filter functionality
document.addEventListener('DOMContentLoaded', function() {
  const filterBtns = document.querySelectorAll('.filter-btn');
  const wrongAnswerItems = document.querySelectorAll('.wrong-answer-item');
  const searchInput = document.getElementById('wrong-answer-search');
  
  // Filter by buttons
  filterBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Remove active class from all buttons
      filterBtns.forEach(b => b.classList.remove('active'));
      // Add active class to clicked button
      this.classList.add('active');
      
      const filter = this.dataset.filter;
      filterWrongAnswers(filter);
    });
  });
  
  // Search functionality
  searchInput.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    filterBySearch(searchTerm);
  });
  
  function filterWrongAnswers(filter) {
    wrongAnswerItems.forEach(item => {
      let show = false;
      
      if (filter === 'all') {
        show = true;
      } else if (filter.startsWith('subject-')) {
        show = item.dataset.subject === filter;
      } else if (filter === 'not-reviewed') {
        show = item.dataset.status === 'not-reviewed';
      } else if (filter === 'reviewed') {
        show = item.dataset.status === 'reviewed';
      } else if (filter === 'bookmarked') {
        show = item.dataset.bookmarked === 'true';
      }
      
      item.style.display = show ? 'block' : 'none';
    });
    
    checkEmptyState();
  }
  
  function filterBySearch(searchTerm) {
    wrongAnswerItems.forEach(item => {
      const questionText = item.querySelector('.wrong-answer-question-title').textContent.toLowerCase();
      const show = questionText.includes(searchTerm);
      item.style.display = show ? 'block' : 'none';
    });
    
    checkEmptyState();
  }
  
  function checkEmptyState() {
    const visibleItems = Array.from(wrongAnswerItems).filter(item => item.style.display !== 'none');
    const emptyState = document.getElementById('empty-wrong-answers');
    const wrongAnswersList = document.querySelector('.wrong-answers-list');
    
    if (visibleItems.length === 0) {
      wrongAnswersList.style.display = 'none';
      emptyState.style.display = 'block';
    } else {
      wrongAnswersList.style.display = 'block';
      emptyState.style.display = 'none';
    }
  }
});

function toggleBookmark(button) {
  const item = button.closest('.wrong-answer-item');
  const icon = button.querySelector('span');
  const isBookmarked = button.classList.contains('active');
  
  if (isBookmarked) {
    button.classList.remove('active');
    icon.textContent = 'ğŸ”–';
    item.dataset.bookmarked = 'false';
  } else {
    button.classList.add('active');
    icon.textContent = 'ğŸ“‘';
    item.dataset.bookmarked = 'true';
  }
}

function markAsReviewed(button) {
  const item = button.closest('.wrong-answer-item');
  const statusSpan = item.querySelector('.wrong-answer-status');
  
  item.dataset.status = 'reviewed';
  statusSpan.className = 'wrong-answer-status wrong-answer-status--reviewed';
  statusSpan.textContent = 'ë³µìŠµì™„ë£Œ âœ“';
  
  // Update button
  button.textContent = 'ë³µìŠµì·¨ì†Œ';
  button.onclick = () => removeFromReviewed(button);
  
  // Add retry score badge if not exists
  const details = item.querySelector('.wrong-answer-details');
  if (!details.querySelector('.wrong-answer-retry-score')) {
    const retryScore = document.createElement('div');
    retryScore.className = 'wrong-answer-retry-score';
    retryScore.innerHTML = '<span class="badge badge--success">ì¬ì‹œë„: 85ì </span>';
    details.appendChild(retryScore);
  }
}

function removeFromReviewed(button) {
  const item = button.closest('.wrong-answer-item');
  const statusSpan = item.querySelector('.wrong-answer-status');
  
  item.dataset.status = 'not-reviewed';
  statusSpan.className = 'wrong-answer-status wrong-answer-status--not-reviewed';
  statusSpan.textContent = 'ë¯¸ë³µìŠµ';
  
  // Update button
  button.textContent = 'ë³µìŠµì™„ë£Œ';
  button.onclick = () => markAsReviewed(button);
  
  // Remove retry score badge
  const retryScore = item.querySelector('.wrong-answer-retry-score');
  if (retryScore) {
    retryScore.remove();
  }
}

function addNote(button) {
  const note = prompt('ì´ ë¬¸ì œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:');
  if (note) {
    alert('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ' + note);
  }
}

function reviewAllWrongAnswers() {
  if (confirm('ëª¨ë“  ë¯¸ë³µìŠµ ì˜¤ë‹µì„ ë³µìŠµ ì™„ë£Œë¡œ í‘œì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    const notReviewedItems = document.querySelectorAll('.wrong-answer-item[data-status="not-reviewed"]');
    notReviewedItems.forEach(item => {
      const button = item.querySelector('.button[onclick*="markAsReviewed"]');
      if (button) {
        markAsReviewed(button);
      }
    });
  }
}

function loadMoreWrongAnswers() {
  // In a real app, this would load more items via AJAX
  alert('ë” ë§ì€ ì˜¤ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ê¸°ëŠ¥ì€ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
}
</script>