<% content_for :page_title, @subject_name %>
<% content_for :back_button do %>
  <%= link_to quiz_selection_path, class: "mobile-header-back" do %>
    <span class="mobile-header-back-icon">â†</span>
  <% end %>
<% end %>

<!-- Subject Header -->
<div class="dashboard-header text-center">
  <h1 class="dashboard-title">
    <%= ["ğŸ”µ", "ğŸŸ£", "ğŸŸ¢", "ğŸŸ ", "ğŸ”´", "ğŸŸ¦"][@subject_id - 1] %> <%= @subject_name %>
  </h1>
  <p class="dashboard-subtitle">ë‚œì´ë„ë³„ í€´ì¦ˆ ì„ íƒ</p>
</div>

<!-- Subject Statistics -->
<div class="dashboard-stats">
  <% total_attempts = @subject_stats.values.sum { |s| s[:attempts] } %>
  <% total_correct = @subject_stats.values.sum { |s| s[:correct] } %>
  <% overall_accuracy = total_attempts > 0 ? (total_correct.to_f / (total_attempts * 20) * 100).round(1) : 0 %>
  
  <div class="dashboard-stat-card">
    <div class="dashboard-stat-title">ì´ ì‹œë„</div>
    <div class="dashboard-stat-value"><%= total_attempts %>íšŒ</div>
  </div>
  <div class="dashboard-stat-card">
    <div class="dashboard-stat-title">í‰ê·  ì •ë‹µë¥ </div>
    <div class="dashboard-stat-value"><%= overall_accuracy %>%</div>
  </div>
  <div class="dashboard-stat-card">
    <div class="dashboard-stat-title">ì´ ë¬¸ì œ</div>
    <div class="dashboard-stat-value"><%= @subject_questions.values.sum { |q| q[:available] } %>ê°œ</div>
  </div>
</div>

<!-- Difficulty Levels -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">ğŸ“ ë‚œì´ë„ë³„ í€´ì¦ˆ</h3>
  </div>
  <div class="card-content">
    <% @difficulty_levels.each do |difficulty| %>
      <% stats = @subject_stats[difficulty] %>
      <% questions = @subject_questions[difficulty] %>
      
      <div class="difficulty-section">
        <div class="difficulty-header">
          <h4 class="difficulty-title">
            <% case difficulty %>
            <% when 'high' %>
              ğŸ’¡ ìƒê¸‰ (ê¸°ë³¸ ê°œë…)
            <% when 'medium_high' %>
              ğŸ”§ ì¤‘ìƒê¸‰ (ì‹¤ë¬´ ì‘ìš©)
            <% when 'highest' %>
              ğŸš€ ìµœìƒê¸‰ (ì¢…í•© ë¬¸ì œ)
            <% end %>
          </h4>
          <span class="badge badge--<%= difficulty == 'high' ? 'easy' : difficulty == 'medium_high' ? 'medium' : 'hard' %>">
            <%= questions[:available] %>ë¬¸ì œ
          </span>
        </div>
        
        <div class="difficulty-stats">
          <div class="stat-item">
            <span class="stat-label">ì‹œë„:</span>
            <span class="stat-value"><%= stats[:attempts] %>íšŒ</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ì •ë‹µë¥ :</span>
            <span class="stat-value"><%= stats[:accuracy] %>%</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">í‰ê· :</span>
            <span class="stat-value"><%= stats[:average_score] %>ì </span>
          </div>
        </div>
        
        <% if questions[:available] > 0 %>
          <%= form_with url: start_quiz_path, method: :post, local: true, class: "quiz-start-form" do |f| %>
            <%= f.hidden_field :subject_id, value: @subject_id %>
            <%= f.hidden_field :difficulty, value: difficulty %>
            
            <% if questions[:sample_question] %>
              <div class="sample-question">
                <p class="sample-question-label">ì˜ˆì‹œ ë¬¸ì œ:</p>
                <p class="sample-question-text">
                  <%= truncate(questions[:sample_question]['question_text'], length: 100) %>
                </p>
              </div>
            <% end %>
            
            <%= f.submit "í€´ì¦ˆ ì‹œì‘ (20ë¬¸ì œ)", 
                class: "button button--primary button--full",
                data: { confirm: "#{@subject_name} #{t("difficulty.#{difficulty}", default: difficulty)} ë‚œì´ë„ í€´ì¦ˆë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" } %>
          <% end %>
        <% else %>
          <div class="alert alert--info">
            <p>ì•„ì§ ì¤€ë¹„ ì¤‘ì¸ ë¬¸ì œì…ë‹ˆë‹¤.</p>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Progress Summary -->
<div class="card">
  <div class="card-header">
    <h3 class="card-title">ğŸ“Š í•™ìŠµ ì§„ë„</h3>
  </div>
  <div class="card-content">
    <% @difficulty_levels.each do |difficulty| %>
      <% stats = @subject_stats[difficulty] %>
      <% progress = stats[:attempts] > 0 ? [stats[:average_score], 100].min : 0 %>
      
      <div class="progress-item">
        <div class="progress-label">
          <span><%= t("difficulty.#{difficulty}", default: difficulty) %></span>
          <span><%= progress.round %>%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-bar-fill" style="width: <%= progress %>%"></div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<style>
.difficulty-section {
  padding: var(--space-4);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-4);
}

.difficulty-section:last-child {
  margin-bottom: 0;
}

.difficulty-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--space-3);
}

.difficulty-title {
  font-size: var(--text-lg);
  font-weight: var(--font-medium);
  margin: 0;
}

.difficulty-stats {
  display: flex;
  gap: var(--space-4);
  margin-bottom: var(--space-4);
  padding: var(--space-3);
  background-color: var(--gray-50);
  border-radius: var(--radius-md);
}

.stat-item {
  display: flex;
  gap: var(--space-2);
}

.stat-label {
  color: var(--gray-600);
  font-size: var(--text-sm);
}

.stat-value {
  font-weight: var(--font-medium);
}

.sample-question {
  margin-bottom: var(--space-4);
  padding: var(--space-3);
  background-color: var(--blue-50);
  border-radius: var(--radius-md);
}

.sample-question-label {
  font-size: var(--text-sm);
  font-weight: var(--font-medium);
  color: var(--blue-700);
  margin-bottom: var(--space-2);
}

.sample-question-text {
  font-size: var(--text-sm);
  color: var(--gray-700);
  margin: 0;
}

.progress-item {
  margin-bottom: var(--space-4);
}

.progress-item:last-child {
  margin-bottom: 0;
}

.progress-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: var(--space-2);
  font-size: var(--text-sm);
}

.progress-bar {
  height: 8px;
  background-color: var(--gray-200);
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background-color: var(--primary-600);
  transition: width 0.3s ease;
}

.quiz-start-form {
  margin-top: var(--space-4);
}
</style>